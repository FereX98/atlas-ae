From 6826df6070b63880b7d1fd826cda9b1b76d2894c Mon Sep 17 00:00:00 2001
From: Lei Chen <ls.cat@outlook.com>
Date: Wed, 7 Dec 2022 00:04:16 +0800
Subject: [PATCH] fix: fix performance bug in the far memory context

---
 phoenix-2.0/Defines.mk                    |  6 ++++++
 phoenix-2.0/include/stddefines.h          |  2 +-
 phoenix-2.0/src/map_reduce.c              | 13 ++++++------
 phoenix-2.0/tests/kmeans/kmeans.c         |  6 ++++--
 phoenix-2.0/tests/word_count/word_count.c | 25 ++++++++---------------
 5 files changed, 26 insertions(+), 26 deletions(-)

diff --git a/phoenix-2.0/Defines.mk b/phoenix-2.0/Defines.mk
index 477da45..8a2b4f9 100644
--- a/phoenix-2.0/Defines.mk
+++ b/phoenix-2.0/Defines.mk
@@ -92,3 +92,9 @@ SRC_DIR = src
 LIB_DIR = lib
 INC_DIR = include
 TESTS_DIR = tests
+#JEMALLOC_DIR = /path-to-jemalloc
+JEMALLOC_DIR = /mnt/ssd/shiliu/Paris/third_party/jemalloc
+ifeq ("$(wildcard $(JEMALLOC_DIR)/lib/libjemalloc.so)","")
+$(error "$(JEMALLOC_DIR)/lib/libjemalloc.so" does not exist, please install jemalloc and set the correct path)
+endif
+LIBS += -L$(JEMALLOC_DIR)/lib -ljemalloc
diff --git a/phoenix-2.0/include/stddefines.h b/phoenix-2.0/include/stddefines.h
index daed8db..d04b615 100644
--- a/phoenix-2.0/include/stddefines.h
+++ b/phoenix-2.0/include/stddefines.h
@@ -33,7 +33,7 @@
 #include <stdint.h>
 #include <stdio.h>
 
-//#define TIMING
+#define TIMING
 
 /* Debug printf */
 #define dprintf(...) fprintf(stdout, __VA_ARGS__)
diff --git a/phoenix-2.0/src/map_reduce.c b/phoenix-2.0/src/map_reduce.c
index b815fbd..103f3b3 100644
--- a/phoenix-2.0/src/map_reduce.c
+++ b/phoenix-2.0/src/map_reduce.c
@@ -60,7 +60,7 @@
 #endif
 
 /* Begin tunables. */
-//#define INCREMENTAL_COMBINER
+#define INCREMENTAL_COMBINER
 
 #define DEFAULT_NUM_REDUCE_TASKS    256
 #define EXTENDED_NUM_REDUCE_TASKS   (DEFAULT_NUM_REDUCE_TASKS * 128)
@@ -208,7 +208,7 @@ static inline int getNumTaskThreads (mr_env_t* env, TASK_TYPE_T);
 static inline void insert_keyval (
     mr_env_t* env, keyval_arr_t *, void *, void *);
 static inline void insert_keyval_merged (
-    mr_env_t* env, keyvals_arr_t *, void *, void *);
+    mr_env_t* env, keyvals_arr_t *, void *, void *, int);
 
 static int array_splitter (void *, int, map_args_t *);
 static void identity_reduce (void *, iterator_t *itr);
@@ -1378,7 +1378,7 @@ emit_intermediate (void *key, void *val, int key_size)
     /* Insert sorted in global queue at pos curr_proc */
     arr = &env->intermediate_vals[curr_task][reduce_pos];
 
-    insert_keyval_merged (env, arr, key, val);
+    insert_keyval_merged (env, arr, key, val, key_size);
 
     get_time (&end);
 
@@ -1437,7 +1437,7 @@ emit (void *key, void *val)
 }
 
 static inline void 
-insert_keyval_merged (mr_env_t* env, keyvals_arr_t *arr, void *key, void *val)
+insert_keyval_merged (mr_env_t* env, keyvals_arr_t *arr, void *key, void *val, int key_size)
 {
     int high = arr->len, low = -1, next;
     int cmp = 1;
@@ -1492,8 +1492,9 @@ insert_keyval_merged (mr_env_t* env, keyvals_arr_t *arr, void *key, void *val)
         /* Insert into array. */
         memmove (&arr->arr[low+1], &arr->arr[low], 
                         (arr->len - low) * sizeof(keyvals_t));
-
-        arr->arr[low].key = key;
+        void* new_key = mem_malloc(key_size);
+        mem_memcpy(new_key, key, key_size);
+        arr->arr[low].key = new_key;
         arr->arr[low].len = 0;
         arr->arr[low].vals = NULL;
         arr->len++;
diff --git a/phoenix-2.0/tests/kmeans/kmeans.c b/phoenix-2.0/tests/kmeans/kmeans.c
index c2be4e6..b706ff6 100644
--- a/phoenix-2.0/tests/kmeans/kmeans.c
+++ b/phoenix-2.0/tests/kmeans/kmeans.c
@@ -421,9 +421,10 @@ int main(int argc, char **argv)
 #ifdef TIMING
     fprintf (stderr, "initialize: %u\n", time_diff (&end, &begin));
 #endif
-
+    const int max_iter = 1;
+    int iter = 0;
     first_run = true;
-    while (modified == true)
+    while (modified == true && iter < max_iter)
     {
         modified = false;
         kmeans_data.next_point = 0;
@@ -452,6 +453,7 @@ int main(int argc, char **argv)
         inter_library_time += time_diff (&end, &begin);
 #endif
         first_run = false;
+        iter ++;
     }  
 
 #ifdef TIMING
diff --git a/phoenix-2.0/tests/word_count/word_count.c b/phoenix-2.0/tests/word_count/word_count.c
index 8b25315..5bad8a1 100644
--- a/phoenix-2.0/tests/word_count/word_count.c
+++ b/phoenix-2.0/tests/word_count/word_count.c
@@ -45,10 +45,10 @@
 #define DEFAULT_DISP_NUM 10
 
 typedef struct {
-    int fpos;
+    long fpos;
     off_t flen;
     char *fdata;
-    int unit_size;
+    long unit_size;
 } wc_data_t;
 
 enum {
@@ -64,7 +64,7 @@ enum {
 /** mystrcmp()
  *  Comparison function to compare 2 words
  */
-int mystrcmp(const void *s1, const void *s2)
+int mystrcmp(const char *s1, const char *s2)
 {
     return strcmp((const char *)s1, (const char *) s2);
 }
@@ -259,19 +259,14 @@ int main(int argc, char *argv[])
     CHECK_ERROR((fd = open(fname, O_RDONLY)) < 0);
     // Get the file info (for file length)
     CHECK_ERROR(fstat(fd, &finfo) < 0);
-#ifndef NO_MMAP
     // Memory map the file
-    CHECK_ERROR((fdata = mmap(0, finfo.st_size + 1, 
+    char* fdata_tmp;
+    CHECK_ERROR((fdata_tmp = mmap(0, finfo.st_size + 1,
       PROT_READ | PROT_WRITE, MAP_PRIVATE, fd, 0)) == NULL);
-#else
-    int ret;
-
-    fdata = (char *)malloc (finfo.st_size);
+    fdata = (char *)malloc (finfo.st_size + 1);
     CHECK_ERROR (fdata == NULL);
-
-    ret = read (fd, fdata, finfo.st_size);
-    CHECK_ERROR (ret != finfo.st_size);
-#endif
+    memcpy(fdata, fdata_tmp, finfo.st_size + 1);
+    munmap(fdata_tmp, finfo.st_size + 1);
 
     // Get the number of results to display
     CHECK_ERROR((disp_num = (disp_num_str == NULL) ? 
@@ -350,11 +345,7 @@ int main(int argc, char *argv[])
 
     free(wc_vals.data);
 
-#ifndef NO_MMAP
-    CHECK_ERROR(munmap(fdata, finfo.st_size + 1) < 0);
-#else
     free (fdata);
-#endif
     CHECK_ERROR(close(fd) < 0);
 
     get_time (&end);
-- 
2.25.1

